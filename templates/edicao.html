<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Cliente</title>
    <!-- Incluindo a biblioteca do Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        font-size: 1rem;
      }
      h1 {
        font-size: 1.875rem;
      }
      h2 {
        font-size: 1.5rem;
      }
      h3 {
        font-size: 1.25rem;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- CABEÇALHO COM NAVEGAÇÃO -->
    <header class="bg-white shadow-md">
      <div class="container mx-auto p-4 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800 text-center flex-grow">
          GERENCIAMENTO DE CLIENTES
        </h1>
        <nav>
          <a
            href="/gerenciamento"
            class="text-gray-600 hover:text-blue-500 font-semibold px-3 py-2 rounded-md"
            >Cadastro</a
          >
          <a
            href="/"
            class="text-gray-600 hover:text-blue-500 font-semibold px-3 py-2 rounded-md"
            >Listagem</a
          >
        </nav>
      </div>
    </header>

    <!-- CONTEÚDO PRINCIPAL: FORMULÁRIO DE EDIÇÃO -->
    <main class="container mx-auto p-4">
      <section class="mt-8">
        <div class="bg-white p-8 rounded-lg shadow-md max-w-xl mx-auto">
          <h2 class="text-2xl font-semibold text-center mb-6 text-gray-700">
            EDITAR CLIENTE
          </h2>

          <form id="form-edicao">
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="nome"
              >
                Nome Completo
              </label>
              <!-- O input de telefone será desabilitado para não ser alterado, pois é a chave de identificação -->
              <input
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="nome"
                type="text"
                placeholder="Nome completo"
                required
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="email"
              >
                E-mail
              </label>
              <input
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="email"
                type="email"
                placeholder="E-mail"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="telefone"
              >
                Telefone
              </label>
              <input
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200"
                id="telefone"
                type="text"
                placeholder="Telefone"
                disabled
              />
            </div>
            <div class="flex items-center justify-between mt-6">
              <button
                id="btn-atualizar"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                type="submit"
              >
                Atualizar Cliente
              </button>
            </div>
          </form>
        </div>
      </section>
    </main>

    <script>
      const API_URL = "/clientes";
      const form = document.getElementById("form-edicao");
      const nomeInput = document.getElementById("nome");
      const emailInput = document.getElementById("email");
      const telefoneInput = document.getElementById("telefone");

      // Função para extrair o parâmetro de telefone da URL
      function getTelefoneFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("telefone");
      }

      // Função para carregar os dados do cliente no formulário
      async function carregarDadosDoCliente(telefone) {
        try {
          const response = await fetch(`${API_URL}/${telefone}`);
          const cliente = await response.json();

          if (response.ok) {
            nomeInput.value = cliente.nome;
            emailInput.value = cliente.email;
            telefoneInput.value = cliente.telefone; // Preenche o campo desabilitado
          } else {
            alert("Erro ao carregar dados do cliente: " + cliente.message);
          }
        } catch (error) {
          console.error("Erro:", error);
          alert("Erro de conexão com o servidor.");
        }
      }

      // Função para enviar os dados atualizados
      async function atualizarCliente(telefone) {
        const clienteAtualizado = {
          nome: nomeInput.value,
          email: emailInput.value,
        };

        try {
          const response = await fetch(`${API_URL}/${telefone}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(clienteAtualizado),
          });

          const result = await response.json();

          if (response.ok) {
            // Ao invés do alerta de sucesso, vamos redirecionar para a listagem.
            window.location.href = "/";
          } else {
            alert("Erro ao atualizar cliente: " + result.message);
          }
        } catch (error) {
          console.error("Erro:", error);
          alert("Erro de conexão com o servidor.");
        }
      }

      // Lógica principal: carregar os dados ao abrir a página
      document.addEventListener("DOMContentLoaded", function () {
        const telefoneCliente = getTelefoneFromUrl();
        if (telefoneCliente) {
          carregarDadosDoCliente(telefoneCliente);
        } else {
          alert(
            "Telefone do cliente não encontrado na URL. Redirecionando para listagem."
          );
          window.location.href = "/listagem";
        }
      });

      // Adicionar o ouvinte para o formulário de atualização
      form.addEventListener("submit", function (event) {
        event.preventDefault();
        const telefoneCliente = getTelefoneFromUrl();
        atualizarCliente(telefoneCliente);
      });
    </script>
  </body>
</html>
